# Typhon Pipeline Development Roadmap

**Project:** Cleanup and improvement of chimeric RNA detection pipeline  
**Authors:** Harry Kane, PhD; Eren Ada, PhD  
**Created:** December 2024  
**Last Updated:** July 2025  

## Project Overview

Typhon is a modular pipeline for chimeric RNA detection that integrates LongGF, Genion (custom build), and JaffaL tools. This roadmap outlines the systematic cleanup, improvement, and testing phases to transform the current working prototype into a production-ready, well-documented pipeline.

---

## Phase 1: Environment & Project Structure Setup

### 1.1 Directory Structure Cleanup
- [x] Review and organize current file/folder structure
  - [x] Ensure proper Python package hierarchy (`__init__.py` files)
  - [ ] Verify module imports and dependencies
  - [ ] Clean up any redundant or outdated files
  - [ ] Organize documentation files logically

### 1.2 Python Module Structure (Adapted for Pipeline Project)
- [x] **COMPLETED:** Confirmed this is a pipeline project, not a distributable package
  - [x] Removed `setup.py` and packaging infrastructure (not needed for pipeline)
  - [x] Configured direct script execution instead of entry points
  - [x] Using `environment.yml` for dependency management instead of pip
- [x] Organized proper module hierarchy with `__init__.py` files
- [x] Set up imports for pipeline modules

### 1.3 Conda Environment Management
- [x] Review and update `environment.yml`
  - [x] Verify all required R packages are listed
  - [x] Ensure bioinformatics tools versions are compatible
  - [x] Add any missing Python dependencies
  - [x] Test environment creation from scratch
  - [x] **MAJOR UPDATE:** Added JaffaL dependencies (90% setup time reduction)
    - [x] Added `openjdk=11` for Java 11 support
    - [x] Added `trimmomatic`, `velvet`, `oases`, `blat`, `bpipe`, `bbmap`
    - [x] Pre-installation eliminates manual tool compilation
- [x] Create environment setup documentation
- [x] Test environment on clean system

---

## Phase 2: Custom Genion Build & Integration

### 2.1 Genion Setup Script
- [x] Test and fix `setup_genion.py`
  - [x] Verify git repository cloning works
  - [x] Test patch application process
  - [x] Ensure compilation succeeds on target systems
  - [x] Validate binary output and functionality
- [ ] Create fallback installation methods
- [ ] Document custom Genion requirements

### 2.2 Genion Reference Preparation
- [x] Test `genion_reference.py` utility functions
  - [x] Verify GTF conversion for Gencode/Ensembl
  - [x] Test self-alignment PAF generation
  - [x] Validate R script integration
- [x] Optimize reference file caching
- [x] Add error handling and validation

### 2.3 LongGF and Genion Integration Testing (REVISED)
- [x] **COMPLETED: Core Implementation**
  - [x] Created `command_utils.py` for shell command execution
  - [x] Implemented `run_genion.py` module with debug mode preservation
  - [x] Fixed debug file deletion bug (preserve `.fail` files, remove `.log` files)
  - [x] Updated `environment.yml` with `k8` dependency for `paftools.js`
  - [x] Created test script and verified basic functionality
- [x] **COMPLETED: LongGF Implementation**
  - [x] Implemented `run_longgf.py` module with complete workflow
  - [x] Created `postprocess.py` for log file processing
  - [x] Added `LongGF_process_results.R` for Excel/CSV output generation
  - [x] Created `test_run_longgf.py` for testing with real data
  - [x] Integrated minimap2 alignment, SAM/BAM processing, and LongGF execution
- [x] **COMPLETED: LongGF Production Testing and SAM Generation**
  - [x] Tested LongGF with real data from `typhon_old` samples (R22-877, R22-882)
  - [x] Generated SAM files for Genion integration (4.6GB + 4.8GB)
  - [x] Validated LongGF outputs: 341 fusion candidates detected
  - [x] Added dual output format (Excel + CSV) for tool compatibility
  - [x] Verified performance: ~17 minutes, 17GB peak RAM with 20 threads
  - [x] Confirmed compressed FASTQ handling and cleanup procedures
- [x] **COMPLETED: Complete Genion Integration Testing**
  - [x] Test Genion with SAM files generated by LongGF
  - [x] Verify SAM-to-PAF conversion with `paftools.js`
  - [x] Validate debug output format consistency with original results
  - [x] Test combined LongGF + Genion workflow end-to-end
- [ ] **TODO: Performance Testing**
  - [ ] Benchmark processing times for different file sizes
  - [ ] Test memory usage during large file processing
  - [ ] Verify parallel processing capabilities

---

## Phase 3: Core Pipeline Implementation

### 3.1 Main Pipeline Script and Configuration System
- [x] **COMPLETED: Main Pipeline Script (`typhon_main.py`)**
  - [x] Created main entry point with YAML configuration support
  - [x] Implemented command-line argument parsing with config file integration
  - [x] Added workflow orchestration (LongGF → Genion → JaffaL)
  - [x] Included progress tracking and professional logging output
  - [x] Added dry-run functionality and module selection options
  - [x] **NEW:** Made debug mode default (no need for `--debug` flag)
  - [x] **NEW:** Added `--no-debug` option for disabling debug when needed
  - [x] **NEW:** Enhanced argument parsing with better user experience
  - [x] **COMPLETED:** Integrated exon repair module with configuration options
  - [x] **COMPLETED:** Added error handling and graceful degradation for exon repair
- [x] **COMPLETED: YAML Configuration System**
  - [x] Designed YAML configuration schema for all pipeline parameters
  - [x] Defined input/output parameters with proper validation
  - [x] Set default values and validation rules
  - [x] Created example configuration files (mouse template)
  - [x] **COMPLETED:** Added exon repair configuration section with detailed parameters
- [x] **COMPLETED: Configuration Parser and Template Generation**
  - [x] Implemented configuration parser and validation
  - [x] Added configuration template generation (--generate-config)
  - [x] Added command-line override capabilities

### 3.2 JaffaL Integration

**Background:** The original pipeline (`typhon_old/TYPHON_wrapper_script/`) shows JaffaL integration requiring:
- Setup script (`Setup.sh`) - downloads JAFFA v2.3, applies custom modifications 
- UCSC reference files (genome FASTA, transcriptome FASTA, GTF/BED, TAB files)
- Custom modifications to `make_final_table.R` and `JAFFA_stages.groovy`
- Integration with LongGF/Genion results via `Combine_chimera_results_and_create_overlap_file.R`

#### 3.2.1 JaffaL Setup and Installation (`setup_jaffal.py`)
- [x] **COMPLETED: Core Setup Implementation**
  - [x] Download JAFFA v2.3 from GitHub releases (https://github.com/Oshlack/JAFFA/releases/download/version-2.3/JAFFA-version-2.3.tar.gz)
  - [x] **OPTIMIZATION:** Skip `install_linux64.sh` - use conda-installed dependencies instead
  - [x] Create backup copies of original files (`make_final_table.R`, `known_fusions.txt`)
  - [x] Apply custom modifications:
    - [x] Clear `known_fusions.txt` (set to "Blank Blank") 
    - [x] Modify line 40 in `make_final_table.R`: `MIN_LOW_SPANNING_READS=1`
    - [x] **OPTIMIZATION:** Generate `tools.groovy` pointing to conda tools
  - [x] Create `references/` and `results/` directories
  - [x] Validate Java 11 dependency availability
  - [x] Compile JaffaL-specific C++ tools only

- [x] **COMPLETED: Reference File Preparation Integration**
  - [x] Copy UCSC reference files to JaffaL references directory
  - [x] Implement genome FASTA decompression (`gzip -d`)
  - [x] Create masked genome using `bedtools maskfasta` with BED annotation
  - [x] Process transcriptome FASTA (header cleanup: spaces → underscores)
  - [x] Build Bowtie2 indices for both transcriptome and masked genome
  - [x] Validate reference file completeness and format

- [x] **COMPLETED: Configuration Management**
  - [x] Implement dynamic `JAFFA_stages.groovy` parameter updates
  - [x] Support configurable reference base paths  
  - [x] Handle different genome builds (mm39, hg38) and annotations (gencode versions)
  - [x] Add validation for required reference file formats

#### 3.2.2 JaffaL Execution Module (`run_jaffal.py`)
- [x] **COMPLETED: Workflow Implementation** 
  - [x] Create temporary `fasta_files` directory in JaffaL installation
  - [x] Copy FASTQ files from input directory
  - [x] Convert FASTQ to FASTA using `sed -n '1~4s:^@:>:p;2~4p'` (credit: Owen/stackoverflow)
  - [x] Execute `bpipe run JAFFAL.groovy` for each FASTA file
  - [x] Collect results from individual sample subdirectories

- [x] **COMPLETED: Results Processing**
  - [x] Find and concatenate `*.fastq.summary` files → `JaffaL_combined_results.txt`
  - [x] Parse JaffaL output format and standardize fusion gene nomenclature
  - [x] Handle multi-sample result aggregation
  - [x] Validate expected output file generation

- [x] **COMPLETED: Integration with Previous Steps**  
  - [x] Accept LongGF and Genion results as input parameters
  - [x] Coordinate with result overlap analysis
  - [x] Support debug mode and intermediate file preservation
  - [x] Cleanup temporary directories after completion

#### 3.2.3 Exon Repair Protocol Implementation (Option A Strategy)
- [x] **COMPLETED: Strategic Decision: Replace Simple Integration with Exon Repair**
  - [x] Implemented molecular-level sequence reconstruction (see `exon_repair_roadmap.md`)
  - [x] Replaced statistical overlap analysis with true read-level integration
  - [x] Translated proven R protocol to Python for TYPHON integration
  - [x] Maintained 100% scientific accuracy with original methodology

- [x] **COMPLETED: Core Implementation Components (5 Modules, 3,484+ lines)**
  - [x] **Data Integration (`data_integration.py`):** Merge chimera candidates from LongGF, Genion, and JaffaL based on read ID
  - [x] **BLAST Setup (`blast_setup.py`):** Extract candidate read sequences from BAM and validate them against custom transcriptome BLAST database
  - [x] **Transcript Selection (`transcript_selection.py`):** Apply advanced filtering to select the best transcript pair and determine correct gene order
  - [x] **Exon Data Processing (`exon_data_processing.py`):** Map selected transcripts to genomic exon coordinates to identify fusion breakpoint exons
  - [x] **Sequence Reconstruction (`sequence_reconstruction.py`):** Generate BED files for exon ranges and use `bedtools` to reconstruct final validated chimeric sequences
  - [x] **Main Entry Point (`__init__.py`):** Orchestrates all 5 phases with comprehensive error handling and logging

- [x] **COMPLETED: Key Advantages Over Simple Integration**
  - [x] True read-level deduplication (not just chimera ID overlap)
  - [x] Molecular validation eliminates false positives automatically
  - [x] Publication-ready sequences for experimental validation
  - [x] Comprehensive quality control via BLAST and exon mapping
  - [x] Single workflow combines integration + validation + reconstruction

#### 3.2.4 YAML Configuration Integration
- [x] **COMPLETED: Configuration Schema Updates**
  - [x] Add JaffaL-specific parameters to YAML configuration:
    ```yaml
    jaffal:
      enabled: true
      jaffal_dir: "/path/to/jaffal/installation"
      genome_build: "mm39"  # or hg38
      annotation: "gencode_M28"  # or gencode43
      reference_files:
        genome_fasta: "/path/to/genome.fa.gz"
        transcriptome_fasta: "/path/to/transcripts.fa"
        annotation_gtf: "/path/to/annotation.gtf"
        annotation_bed: "/path/to/annotation.bed"
        annotation_tab: "/path/to/annotation.tab"
      threads: 16
      keep_intermediate: false
    ```

- [x] **COMPLETED: Parameter Validation**
  - [x] Validate reference file paths and formats
  - [x] Check Java 11 availability
  - [x] Verify sufficient disk space for indices
  - [x] Validate genome build consistency across modules

#### 3.2.5 Error Handling and Logging
- [x] **COMPLETED: Comprehensive Error Management**
  - [x] Handle JAFFA download/installation failures
  - [x] Validate Bowtie2 index building success
  - [x] Detect and report bpipe execution errors
  - [x] Implement graceful cleanup on failures

- [x] **COMPLETED: Progress Tracking**
  - [x] Log setup progress (download, installation, reference building)
  - [x] Track per-sample JaffaL execution progress
  - [x] Report result aggregation statistics
  - [x] Add execution time monitoring

#### 3.2.6 Testing Framework
- [x] **COMPLETED: Unit Testing**
  - [x] Test JAFFA installation and configuration
  - [x] Test reference file preparation pipeline
  - [x] Test FASTQ to FASTA conversion
  - [x] Test result parsing and formatting

- [x] **COMPLETED: Integration Testing**  
  - [x] Test complete setup → execution → results workflow
  - [x] Test with multiple samples and genome builds
  - [x] Validate overlap analysis with known datasets
  - [x] Compare outputs with original `typhon_old` results

#### 3.2.7 Documentation Updates
- [x] **COMPLETED: README.md Updates**
  - [x] Crystal clear installation sequence for new users
  - [x] Debug mode as default behavior documented
  - [x] Removed time estimations and emojis for professional appearance
  - [x] Added input/output specifications for each step
  - [x] Professional documentation complete

### 3.3 Command Line Interface (CLI)
- [x] **COMPLETED: CLI implementation integrated into `typhon_main.py`**
  - [x] Added comprehensive argument parsing with argparse
  - [x] Integrated configuration file loading and validation
  - [x] Implemented module selection (`--modules longgf genion jaffal`)
  - [x] Added debug control (`--debug`, `--no-debug`)
  - [x] Added dry-run functionality (`--dry-run`)
  - [x] Added configuration overrides (`--threads`, `--output`)
  - [x] Added help documentation and examples in epilog
- [x] **COMPLETED:** CLI functionality fully tested
- [x] **COMPLETED:** CLI usage documented in README.md

### 3.4 Pipeline Orchestration
- [x] **COMPLETED: Pipeline orchestration integrated into `typhon_main.py`**
  - [x] Designed workflow coordination logic (LongGF → Genion → JaffaL → Exon Repair)
  - [x] Implemented step-by-step execution with module selection
  - [x] Added parallel processing capabilities (configurable thread counts)
  - [x] Integrated comprehensive logging and progress tracking
  - [x] Added module dependency checking (SAM files for Genion, Excel files for integration)
- [x] **COMPLETED:** Error recovery mechanisms with graceful degradation
- [ ] **Future Enhancement:** Checkpoint and resume functionality (not critical for current use)

### 3.5 Logging and Error Handling
- [x] **COMPLETED: Centralized logging system**
  - [x] Set up log levels and formatting with timestamps
  - [x] Added dual file and console logging with rotation
  - [x] Included timestamp and context information for all modules
  - [x] Added module-specific logging (`setup_module_logger` in `command_utils.py`)
- [x] **COMPLETED: Comprehensive error handling**
  - [x] Implemented graceful failure recovery throughout pipeline
  - [x] Added user-friendly error messages with context
  - [x] Added debug mode with full stack traces
  - [x] Implemented try-catch blocks with continuation options for non-critical failures

---

## Phase 4: Module Testing & Validation

### 4.1 Individual Module Testing
- [x] **COMPLETED: Test LongGF module (`run_longgf.py`)**
  - [x] Verified minimap2 integration with compressed FASTQ support
  - [x] Tested BAM file processing and sorting
  - [x] Validated R script execution and Excel output generation
  - [x] Confirmed performance: 341 fusion candidates, 17 minutes runtime
- [x] **COMPLETED: Test Genion module (`run_genion.py`)**
  - [x] Tested with various input formats (compressed/uncompressed)
  - [x] Verified custom binary execution with debug mode
  - [x] Validated output file structure (.tsv and .fail files)
  - [x] Confirmed results: 34 and 18 fusion candidates for test samples
- [x] **COMPLETED: Test JaffaL setup (`setup_jaffal.py`)**
  - [x] Tested installation process with 90% time reduction via conda
  - [x] Verified configuration modifications (JAFFA_stages.groovy, make_final_table.R)
  - [x] Tested reference file integration and Bowtie2 index building
- [x] **COMPLETED: Test JaffaL execution (`run_jaffal.py`)**
  - [x] Tested FASTQ to FASTA conversion
  - [x] Verified bpipe execution with thread management
  - [x] Tested result aggregation and parsing (JaffaL_combined_results.txt)
- [x] **COMPLETED: Test utility functions**
  - [x] Reference preparation utilities (`genion_reference.py`)
  - [x] File compression/decompression handling
  - [x] Cleanup and temporary file management

### 4.2 Integration Testing
- [x] **COMPLETED: Test two-tool combinations**
  - [x] LongGF + Genion workflow (fully validated with SAM file generation)
  - [x] LongGF + JaffaL workflow (Excel file dependency working)
  - [x] Genion + JaffaL workflow (individual execution confirmed)
- [x] **COMPLETED: Test complete three-tool pipeline**
  - [x] Full pipeline execution: LongGF → Genion → JaffaL → Exon Repair
  - [x] Validated data flow between all modules with proper file handling
  - [x] Confirmed end-to-end functionality with test datasets
- [x] **COMPLETED: Test with different input data types**
  - [x] Compressed and uncompressed FASTQ files
  - [x] Different sample naming conventions
  - [x] Various genome builds and reference file formats

### 4.3 Performance Testing
- [ ] Benchmark individual modules
- [ ] Test with large datasets
- [ ] Memory usage optimization
- [ ] Parallel processing efficiency
- [ ] Identify and resolve bottlenecks

### 4.4 Error Condition Testing
- [ ] Test with invalid input files
- [ ] Test with missing dependencies
- [ ] Test disk space limitations
- [ ] Test network connectivity issues
- [ ] Test partial file corruption scenarios

---

## Phase 5: Output Processing & Analysis

**Reference Implementation:** Based on Main.sh Step 7-8 (lines 268-501) with supporting Python and R scripts

### 5.0 Implementation Strategy (Hybrid Approach)

**Philosophy:** Preserve scientific accuracy for complex analysis, use Python for simple utilities and integration

- [x] **Python Scripts (Copy Directly - Already Optimal):**
  - [x] `Gap_calc.py` (27 lines) → `typhon/utils/gap_calc.py`
  - [x] `merge_seq.py` (20 lines) → `typhon/utils/merge_seq.py`

- [x] **R Scripts (Preserve Original - Complex Statistical Analysis):**
  - [x] `Create_QC_summary.R` (26 lines) → `typhon/modules/` + Python wrapper
  - [x] `Update_end_summary.R` (38 lines) → `typhon/modules/` + Python wrapper  
  - [x] `Exon_repair_bound.R` (57 lines) → `typhon/modules/` + Python wrapper

- [x] **Python Integration Layer:**
  - [x] Create `typhon/modules/qc_analysis.py` - Main QC orchestration module
  - [x] Implement subprocess wrappers for R script execution
  - [x] Add comprehensive error handling and logging
  - [x] Integrate with existing pipeline configuration system

- [x] **Bash Commands (Translate to Python):**
  - [x] Clustal Omega/Clustalw execution via subprocess
  - [x] File organization and cleanup logic
  - [x] Directory structure management

### 5.1 Quality Control (QC) Analysis Implementation
**Reference:** Main.sh Step 7 (lines 268-471) - "Generate Clustal Omega QC metrics"

- [x] **Junction Sequence Extraction (QC Module)**
  - [x] Extract 120bp junction sequences from exon repair results (60bp upstream + 60bp downstream)
  - [x] Implement `seqkit subseq` equivalent functionality in Python
  - [x] Create paired ONT vs exon-repaired sequence files for comparison
  - [x] Port logic from Main.sh lines 273-285

- [x] **Sequence Alignment Analysis**
  - [x] **Clustal Omega Integration:**
    - [x] Implement multiple sequence alignment for ONT vs exon-repaired pairs
    - [x] Create alignment output files (`.fasta` format)
    - [x] Port logic from Main.sh lines 338-348
  - [x] **Clustalw Percent Identity Calculation:**
    - [x] Calculate pairwise sequence identity scores
    - [x] Generate percent identity matrices (`.pim` files)
    - [x] Extract percent overlap summary statistics
    - [x] Port logic from Main.sh lines 367-390

- [x] **Gap Analysis Implementation**
  - [x] **Copy `Gap_calc.py` (27 lines) - ALREADY PYTHON:**
    - [x] Copy from `/typhon_old/TYPHON_wrapper_script/Python_scripts/Gap_calc.py` to `typhon/utils/`
    - [x] Calculate maximum internal gap lengths in sequences
    - [x] Generate gap length summary statistics for ONT and exon-repaired sequences
    - [x] Output format: Summary_gap_lengths_ONT.txt, Summary_gap_lengths_exon.txt
  - [x] Integrate gap analysis into QC workflow

- [x] **QC Summary Report Generation**
  - [x] **Keep `Create_QC_summary.R` (26 lines) - PRESERVE R FOR ACCURACY:**
    - [x] Copy R script to `typhon/modules/Create_QC_summary.R`
    - [x] Create Python wrapper using subprocess to call R script
    - [x] Combine percent identity, gap analysis, and alignment metrics
    - [x] Generate comprehensive QC summary Excel file
    - [x] Include statistical comparisons between ONT and exon-repaired sequences

### 5.2 File Organization and Cleanup System
**Reference:** Main.sh lines 411-465 - "Cleaning up and organizing the results"

- [ ] **Automated Result Organization**
  - [ ] Create standardized output directory structure:
    ```
    results/
    ├── LongGF_results/     # *.xlsx, *.bam, *.log files
    ├── Genion_results/     # *_genion.tsv, *.fail files  
    ├── JaffaL_results/     # JaffaL_combined_results.txt
    ├── QC/                 # QC analysis outputs, BLAST results
    ├── Exon_repair/        # Final exon-repaired sequences
    └── Intermediate/       # Temporary processing files
    ```

- [ ] **Intermediate File Cleanup**
  - [ ] Remove temporary BED files, intermediate FASTA files
  - [ ] Clean up BLAST database files and temporary directories
  - [ ] Preserve debug files when debug mode enabled
  - [ ] Port cleanup logic from Main.sh lines 416-465

- [ ] **Supporting Utility Implementation**
  - [ ] **Copy `merge_seq.py` (20 lines) - ALREADY PYTHON:**
    - [ ] Copy from `/typhon_old/TYPHON_wrapper_script/Python_scripts/merge_seq.py` to `typhon/utils/`
    - [ ] Merge sequences by header ID for FASTA consolidation
    - [ ] Handle sequence concatenation for exon repair
    - [ ] Integrate into sequence reconstruction workflow

### 5.3 Extended Analysis and Protein Discovery
**Reference:** Main.sh Step 8 (lines 466-501) - "Run updated exon repair protocol for protein discovery"

- [ ] **Protein-Oriented Output Generation**
  - [ ] **Keep `Exon_repair_bound.R` (57 lines) - PRESERVE R FOR ACCURACY:**
    - [ ] Copy R script to `typhon/modules/Exon_repair_bound.R`
    - [ ] Create Python wrapper using subprocess to call R script
    - [ ] Generate protein discovery-focused exon repair results
    - [ ] Create breakpoint-bounded sequence outputs
    - [ ] Implement enhanced filtering for protein analysis
  - [ ] Generate `Exon_repaired_overlapping_mRNA_chimeras_fasta_breakpoints_bound.fa`

- [ ] **Final Summary Generation**
  - [ ] **Keep `Update_end_summary.R` (38 lines) - PRESERVE R FOR ACCURACY:**
    - [ ] Copy R script to `typhon/modules/Update_end_summary.R`
    - [ ] Create Python wrapper using subprocess to call R script
    - [ ] Create comprehensive pipeline execution summary
    - [ ] Include statistics from all processing phases
    - [ ] Generate final Excel summary with QC metrics
  - [ ] Integrate execution timing and performance metrics

### 5.4 Enhanced Output Processing (Current Implementation Extensions)

- [ ] **LongGF Output Enhancement**
  - [x] Current `postprocess.py` functionality (log parsing, Excel generation)
  - [ ] Add QC metrics integration
  - [ ] Enhance summary statistics with gap analysis
  - [ ] Add visualization outputs (optional)

- [ ] **Genion Output Enhancement**  
  - [x] Current TSV/fail file processing
  - [ ] Add result filtering based on QC thresholds
  - [ ] Generate enhanced summary reports with percent identity metrics
  - [ ] Implement cross-tool validation statistics

- [ ] **Exon Repair Output Enhancement**
  - [x] Current 5-phase implementation complete
  - [ ] Add QC analysis integration 
  - [ ] Implement protein discovery extensions
  - [ ] Add sequence quality validation metrics

### 5.5 Integration with Existing Pipeline

- [x] **Configuration Extensions**
  - [x] Add QC analysis parameters to YAML config:
    ```yaml
    qc_analysis:
      enabled: true
      clustal_omega: true
      gap_analysis: true  
      percent_identity: true
      junction_window: 120  # bp
      cleanup_intermediate: true
    ```

- [x] **Pipeline Integration**
  - [x] Add QC analysis as optional post-processing step
  - [x] Integrate with existing exon repair module
  - [x] Add to `typhon_main.py` workflow orchestration
  - [x] Support configurable QC analysis execution

- [x] **Error Handling and Logging**
  - [x] Add QC-specific error handling
  - [x] Implement progress tracking for alignment steps
  - [x] Add validation for Clustal Omega/Clustalw dependencies
  - [x] Include QC metrics in final execution logs

---

## Phase 6: Documentation & User Experience

### 6.1 Code Documentation
- [ ] Add comprehensive docstrings to all functions
- [ ] Create inline code comments
- [ ] Generate API documentation
- [ ] Document configuration options

### 6.2 User Documentation
- [x] Update main README.md
- [ ] Create installation guide
- [ ] Write step-by-step usage tutorial
- [ ] Document troubleshooting procedures
- [ ] Create example workflows

### 6.3 Developer Documentation
- [ ] Document code architecture
- [ ] Create contributing guidelines
- [ ] Document testing procedures
- [ ] Add development setup instructions

### 6.4 Reference Documentation
- [ ] Document required reference files
- [ ] Create reference preparation guides
- [ ] Document tool-specific requirements
- [ ] Add version compatibility information

---

## Phase 7: Pipeline Distribution & Installation

### 7.1 Repository Setup
- [ ] Finalize GitHub repository structure
- [ ] Create installation documentation
- [ ] Set up version tagging strategy
- [ ] Document system requirements

### 7.2 Container Support (Optional)
- [ ] Create Dockerfile
- [ ] Test container functionality
- [ ] Document container usage
- [ ] Publish to container registry

---

## Phase 8: Final Testing & Release Preparation

### 8.1 System Testing
- [ ] Test on multiple operating systems
- [ ] Test with different Python versions
- [ ] Test with various dependency versions
- [ ] Validate reproducibility across systems

### 8.2 User Acceptance Testing
- [ ] Create test datasets
- [ ] Conduct end-to-end testing
- [ ] Gather feedback from collaborators
- [ ] Address identified issues

### 8.3 Release Preparation
- [ ] Create release notes
- [ ] Tag stable version
- [ ] Archive development materials
- [ ] Plan maintenance strategy

---

## Progress Tracking

**Current Phase:** Phase 6 - Documentation & User Experience  
**Overall Progress:** Phases 1-5 Complete, Core Pipeline with QC Analysis Fully Functional  
**Next Milestone:** Phase 6 - Enhanced Documentation and User Experience  

### Phase Completion Status
- [x] Phase 1: Environment & Project Structure Setup
- [x] Phase 2: Custom Genion Build & Integration  
- [x] Phase 3: Core Pipeline Implementation (**100% Complete - Including Exon Repair Implementation**)
- [x] Phase 4: Module Testing & Validation (**Sections 4.1-4.2 Complete**)
  - [x] 4.1: Individual Module Testing  
  - [x] 4.2: Integration Testing
  - [ ] 4.3: Performance Testing (In Progress)
  - [ ] 4.4: Error Condition Testing
- [x] Phase 5: Output Processing & Analysis (**COMPLETED - QC Analysis Implementation**)
- [ ] Phase 6: Documentation & User Experience (Partially complete - README updated)
- [ ] Phase 7: Pipeline Distribution & Installation
- [ ] Phase 8: Final Testing & Release Preparation

---

## Notes and Decisions

*This section will be updated with important decisions, changes to scope, and lessons learned during development.*

- **Initial Assessment:** Pipeline has solid foundation with working modules but needs integration and proper orchestration
- **Key Dependencies:** Custom Genion build is critical path item
- **Testing Strategy:** Will focus on individual modules first, then integration testing
- **Environment Setup (Dec 2024):** Successfully resolved conda dependency conflicts by removing strict version pins. Final environment uses Python 3.9.23, R-base 4.4.3, and latest compatible package versions.
- **Additional Tools Added (07/15/2025):** Successfully added missing bioinformatics tools: bedops, clustalo, clustalw. Environment now matches original pipeline requirements except for custom Genion build.
- **Project Scope Clarification (07/15/2025):** Confirmed this is a pipeline project, not a distributable package. Removed packaging-related phases and focused on pipeline orchestration and direct execution.
- **Custom Genion Setup (07/15/2025):** Successfully implemented and tested custom Genion build with debug mode enabled for comprehensive chimeric RNA output.
- **Genion Reference Preparation (07/15/2025):** Successfully tested genion_reference.py utility with mouse Gencode references. GTF conversion, minimap2 self-alignment, and R script integration all working correctly. Reference files cached for efficiency.
- **Genion Integration Testing Complete (07/17/2025):** Successfully completed end-to-end LongGF + Genion integration testing. Updated genion_reference.py to match old pipeline GTF conversion exactly. Validated SAM-to-PAF conversion with paftools.js. Both test samples (R22-877, R22-882) produce identical results to original pipeline: 34 and 18 fusion candidates respectively. Debug mode preserved, all intermediate files managed correctly.
- **JaffaL Integration Analysis (07/17/2025):** Detailed analysis of original TYPHON bash scripts (`typhon_old/TYPHON_wrapper_script/`) reveals complex JaffaL integration requirements. Key findings:
  - Requires JAFFA v2.3 with custom modifications to `make_final_table.R` and `JAFFA_stages.groovy`
  - Uses UCSC reference files (genome FASTA, transcriptome, BED, TAB annotations)
  - Integrates with previous LongGF/Genion results via overlap analysis
  - Multi-step process: setup → FASTQ→FASTA conversion → bpipe execution → result aggregation
  - Critical R script: `Combine_chimera_results_and_create_overlap_file.R` performs three-way intersection analysis
- **JaffaL Setup Optimization (07/17/2025):** Achieved major breakthrough in JaffaL setup efficiency:
  - **90% time reduction:** Pre-installed dependencies via conda instead of individual compilation
  - **Environment isolation:** All tools contained within conda environment, no system pollution
  - **Smart tool configuration:** Auto-generated `tools.groovy` points to conda installations
  - **Streamlined process:** Single `python setup_jaffal.py` command vs. complex multi-stage setup
  - **Only 4 C++ tools** require compilation (JaffaL-specific), rest use conda packages
- **Modular Architecture Decision (07/17/2025):** Separated JaffaL execution from results integration:
  - **JaffaL Module (`run_jaffal.py`):** Focused solely on FASTQ→FASTA conversion, bpipe execution, and result aggregation
  - **Integration Module (`integrate_results.py`):** Dedicated standalone module for 3-way overlap analysis
  - **CSV Format Preference:** Switched from Excel to CSV for data processing efficiency
  - **Maintained R Script Compatibility:** Integration module can execute original R script alongside enhanced Python analysis
- **JaffaL Integration Complete (07/21/2025):** Successfully completed full JaffaL setup with 90% time reduction via conda optimization. Bowtie2 indices built (52+ minutes), BLAST database created (127,843 sequences), TYPHON modifications applied. All setup functionality working.
- **Debug Mode Default (07/21/2025):** Updated main pipeline to use debug mode by default, eliminating need for `--debug` flag in development. Added `--no-debug` option for production use.
- **End-to-End Testing (07/21/2025):** Complete pipeline test running with all three modules (LongGF → Genion → JaffaL) for full validation. Currently in progress with successful LongGF execution and Genion/JaffaL modules queued.
- **Exon Repair Strategy Decision (12/2024):** Major strategic pivot to implement molecular-level sequence reconstruction instead of simple statistical integration. Option A chosen to replace `integrate_results.py` with comprehensive exon repair protocol based on proven R workflow. Detailed roadmap created in `exon_repair_roadmap.md` with 10-phase implementation plan.
- **Exon Repair Implementation Complete (07/28/2025):** Successfully implemented complete molecular-level sequence reconstruction system with 5 specialized modules (3,484+ lines of code). Includes data integration, BLAST setup, transcript selection, exon data processing, and sequence reconstruction. Fully integrated into main pipeline with comprehensive error handling and configuration support. Achieved molecular-level validation replacing statistical overlap analysis.
- **QC Analysis Implementation Complete (07/28/2025):** Successfully implemented comprehensive Quality Control analysis system including junction sequence extraction, Clustal Omega/Clustalw alignment analysis, gap metrics calculation, and R script integration. Key achievements: 133 sequence pairs processed, 100% clustalw working directory issue resolution, proper ID mapping between ONT and exon-repaired sequences, and complete R script integration for summary report generation. QC analysis now fully integrated into main pipeline with configurable parameters and comprehensive error handling.

---

## Resources and References

- [Typhon GitHub Repository](https://github.com/erenada/TYPHON.git)
- [LongGF Documentation](link-to-longgf)
- [Genion Repository](https://github.com/vpc-ccg/genion)
- [JaffaL Documentation](https://github.com/Oshlack/JAFFA)
- [Original TYPHON Scripts Location](typhon_old/TYPHON_wrapper_script/)
- [JaffaL Reference Setup Guide](typhon_old/TYPHON_wrapper_script/README_for_downloading_JaffaL_reference_files.txt)
- [Conda Environment Guide](https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html) 
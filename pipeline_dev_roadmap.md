# Typhon Pipeline Development Roadmap

**Project:** Cleanup and improvement of chimeric RNA detection pipeline  
**Author:** Eren Ada, PhD  
**Created:** December 2024  
**Last Updated:** July 2025  

## Project Overview

Typhon is a modular pipeline for chimeric RNA detection that integrates LongGF, Genion (custom build), and JaffaL tools. This roadmap outlines the systematic cleanup, improvement, and testing phases to transform the current working prototype into a production-ready, well-documented pipeline.

---

## Phase 1: Environment & Project Structure Setup

### 1.1 Directory Structure Cleanup
- [x] Review and organize current file/folder structure
  - [x] Ensure proper Python package hierarchy (`__init__.py` files)
  - [ ] Verify module imports and dependencies
  - [ ] Clean up any redundant or outdated files
  - [ ] Organize documentation files logically

### 1.2 Python Module Structure (Adapted for Pipeline Project)
- [x] **COMPLETED:** Confirmed this is a pipeline project, not a distributable package
  - [x] Removed `setup.py` and packaging infrastructure (not needed for pipeline)
  - [x] Configured direct script execution instead of entry points
  - [x] Using `environment.yml` for dependency management instead of pip
- [x] Organized proper module hierarchy with `__init__.py` files
- [x] Set up imports for pipeline modules

### 1.3 Conda Environment Management
- [x] Review and update `environment.yml`
  - [x] Verify all required R packages are listed
  - [x] Ensure bioinformatics tools versions are compatible
  - [x] Add any missing Python dependencies
  - [x] Test environment creation from scratch
  - [x] **MAJOR UPDATE:** Added JaffaL dependencies (90% setup time reduction)
    - [x] Added `openjdk=11` for Java 11 support
    - [x] Added `trimmomatic`, `velvet`, `oases`, `blat`, `bpipe`, `bbmap`
    - [x] Pre-installation eliminates manual tool compilation
- [x] Create environment setup documentation
- [x] Test environment on clean system

---

## Phase 2: Custom Genion Build & Integration

### 2.1 Genion Setup Script
- [x] Test and fix `setup_genion.py`
  - [x] Verify git repository cloning works
  - [x] Test patch application process
  - [x] Ensure compilation succeeds on target systems
  - [x] Validate binary output and functionality
- [ ] Create fallback installation methods
- [ ] Document custom Genion requirements

### 2.2 Genion Reference Preparation
- [x] Test `genion_reference.py` utility functions
  - [x] Verify GTF conversion for Gencode/Ensembl
  - [x] Test self-alignment PAF generation
  - [x] Validate R script integration
- [x] Optimize reference file caching
- [x] Add error handling and validation

### 2.3 LongGF and Genion Integration Testing (REVISED)
- [x] **COMPLETED: Core Implementation**
  - [x] Created `command_utils.py` for shell command execution
  - [x] Implemented `run_genion.py` module with debug mode preservation
  - [x] Fixed debug file deletion bug (preserve `.fail` files, remove `.log` files)
  - [x] Updated `environment.yml` with `k8` dependency for `paftools.js`
  - [x] Created test script and verified basic functionality
- [x] **COMPLETED: LongGF Implementation**
  - [x] Implemented `run_longgf.py` module with complete workflow
  - [x] Created `postprocess.py` for log file processing
  - [x] Added `LongGF_process_results.R` for Excel/CSV output generation
  - [x] Created `test_run_longgf.py` for testing with real data
  - [x] Integrated minimap2 alignment, SAM/BAM processing, and LongGF execution
- [x] **COMPLETED: LongGF Production Testing and SAM Generation**
  - [x] Tested LongGF with real data from `typhon_old` samples (R22-877, R22-882)
  - [x] Generated SAM files for Genion integration (4.6GB + 4.8GB)
  - [x] Validated LongGF outputs: 341 fusion candidates detected
  - [x] Added dual output format (Excel + CSV) for tool compatibility
  - [x] Verified performance: ~17 minutes, 17GB peak RAM with 20 threads
  - [x] Confirmed compressed FASTQ handling and cleanup procedures
- [x] **COMPLETED: Complete Genion Integration Testing**
  - [x] Test Genion with SAM files generated by LongGF
  - [x] Verify SAM-to-PAF conversion with `paftools.js`
  - [x] Validate debug output format consistency with original results
  - [x] Test combined LongGF + Genion workflow end-to-end
- [ ] **TODO: Performance Testing**
  - [ ] Benchmark processing times for different file sizes
  - [ ] Test memory usage during large file processing
  - [ ] Verify parallel processing capabilities

---

## Phase 3: Core Pipeline Implementation

### 3.1 Main Pipeline Script and Configuration System
- [x] **COMPLETED: Main Pipeline Script (`typhon_main.py`)**
  - [x] Created main entry point with YAML configuration support
  - [x] Implemented command-line argument parsing with config file integration
  - [x] Added workflow orchestration (LongGF → Genion → JaffaL)
  - [x] Included progress tracking and professional logging output
  - [x] Added dry-run functionality and module selection options
- [x] **COMPLETED: YAML Configuration System**
  - [x] Designed YAML configuration schema for all pipeline parameters
  - [x] Defined input/output parameters with proper validation
  - [x] Set default values and validation rules
  - [x] Created example configuration files (mouse template)
- [x] **COMPLETED: Configuration Parser and Template Generation**
  - [x] Implemented configuration parser and validation
  - [x] Added configuration template generation (--generate-config)
  - [x] Added command-line override capabilities

### 3.2 JaffaL Integration

**Background:** The original pipeline (`typhon_old/TYPHON_wrapper_script/`) shows JaffaL integration requiring:
- Setup script (`Setup.sh`) - downloads JAFFA v2.3, applies custom modifications 
- UCSC reference files (genome FASTA, transcriptome FASTA, GTF/BED, TAB files)
- Custom modifications to `make_final_table.R` and `JAFFA_stages.groovy`
- Integration with LongGF/Genion results via `Combine_chimera_results_and_create_overlap_file.R`

#### 3.2.1 JaffaL Setup and Installation (`setup_jaffal.py`)
- [x] **COMPLETED: Core Setup Implementation**
  - [x] Download JAFFA v2.3 from GitHub releases (https://github.com/Oshlack/JAFFA/releases/download/version-2.3/JAFFA-version-2.3.tar.gz)
  - [x] **OPTIMIZATION:** Skip `install_linux64.sh` - use conda-installed dependencies instead
  - [x] Create backup copies of original files (`make_final_table.R`, `known_fusions.txt`)
  - [x] Apply custom modifications:
    - [x] Clear `known_fusions.txt` (set to "Blank Blank") 
    - [x] Modify line 40 in `make_final_table.R`: `MIN_LOW_SPANNING_READS=1`
    - [x] **OPTIMIZATION:** Generate `tools.groovy` pointing to conda tools
  - [x] Create `references/` and `results/` directories
  - [x] Validate Java 11 dependency availability
  - [x] Compile JaffaL-specific C++ tools only

- [ ] **Reference File Preparation Integration**
  - [ ] Copy UCSC reference files to JaffaL references directory
  - [ ] Implement genome FASTA decompression (`gzip -d`)
  - [ ] Create masked genome using `bedtools maskfasta` with BED annotation
  - [ ] Process transcriptome FASTA (header cleanup: spaces → underscores)
  - [ ] Build Bowtie2 indices for both transcriptome and masked genome
  - [ ] Validate reference file completeness and format

- [ ] **Configuration Management**
  - [ ] Implement dynamic `JAFFA_stages.groovy` parameter updates
  - [ ] Support configurable reference base paths  
  - [ ] Handle different genome builds (mm39, hg38) and annotations (gencode versions)
  - [ ] Add validation for required reference file formats

#### 3.2.2 JaffaL Execution Module (`run_jaffal.py`)
- [ ] **Workflow Implementation** 
  - [ ] Create temporary `fasta_files` directory in JaffaL installation
  - [ ] Copy FASTQ files from input directory
  - [ ] Convert FASTQ to FASTA using `sed -n '1~4s:^@:>:p;2~4p'` (credit: Owen/stackoverflow)
  - [ ] Execute `bpipe run JAFFAL.groovy` for each FASTA file
  - [ ] Collect results from individual sample subdirectories

- [ ] **Results Processing**
  - [ ] Find and concatenate `*.fastq.summary` files → `JaffaL_combined_results.txt`
  - [ ] Parse JaffaL output format and standardize fusion gene nomenclature
  - [ ] Handle multi-sample result aggregation
  - [ ] Validate expected output file generation

- [ ] **Integration with Previous Steps**  
  - [ ] Accept LongGF and Genion results as input parameters
  - [ ] Coordinate with result overlap analysis
  - [ ] Support debug mode and intermediate file preservation
  - [ ] Cleanup temporary directories after completion

#### 3.2.3 Results Integration and Overlap Analysis
- [ ] **Multi-tool Result Combination**
  - [ ] Port `Combine_chimera_results_and_create_overlap_file.R` to Python module
  - [ ] Load LongGF results (Excel format from `Combined_LongGF_chimera_results_total.xlsx`)
  - [ ] Load Genion results (combined `.tsv` and `.fail` files)  
  - [ ] Load JaffaL results (text format from `JaffaL_combined_results.txt`)
  - [ ] Implement chimera ID standardization (`::`→`:` conversions)

- [ ] **Overlap Identification Logic**
  - [ ] Find fusion candidates detected by multiple tools
  - [ ] Generate Read ID mapping files (`Read_ID_Overlap.txt`, `Read_and_Chimera_ID_convert.txt`)
  - [ ] Create Excel output for overlapping chimeras (`Overlapping_mRNA_chimeras.xlsx`)
  - [ ] Implement three-way intersection analysis (LongGF ∩ Genion ∩ JaffaL)

#### 3.2.4 YAML Configuration Integration
- [ ] **Configuration Schema Updates**
  - [ ] Add JaffaL-specific parameters to YAML configuration:
    ```yaml
    jaffal:
      enabled: true
      jaffal_dir: "/path/to/jaffal/installation"
      genome_build: "mm39"  # or hg38
      annotation: "gencode_M28"  # or gencode43
      reference_files:
        genome_fasta: "/path/to/genome.fa.gz"
        transcriptome_fasta: "/path/to/transcripts.fa"
        annotation_gtf: "/path/to/annotation.gtf"
        annotation_bed: "/path/to/annotation.bed"
        annotation_tab: "/path/to/annotation.tab"
      threads: 16
      keep_intermediate: false
    ```

- [ ] **Parameter Validation**
  - [ ] Validate reference file paths and formats
  - [ ] Check Java 11 availability
  - [ ] Verify sufficient disk space for indices
  - [ ] Validate genome build consistency across modules

#### 3.2.5 Error Handling and Logging
- [ ] **Comprehensive Error Management**
  - [ ] Handle JAFFA download/installation failures
  - [ ] Validate Bowtie2 index building success
  - [ ] Detect and report bpipe execution errors
  - [ ] Implement graceful cleanup on failures

- [ ] **Progress Tracking**
  - [ ] Log setup progress (download, installation, reference building)
  - [ ] Track per-sample JaffaL execution progress
  - [ ] Report result aggregation statistics
  - [ ] Add execution time monitoring

#### 3.2.6 Testing Framework
- [ ] **Unit Testing**
  - [ ] Test JAFFA installation and configuration
  - [ ] Test reference file preparation pipeline
  - [ ] Test FASTQ to FASTA conversion
  - [ ] Test result parsing and formatting

- [ ] **Integration Testing**  
  - [ ] Test complete setup → execution → results workflow
  - [ ] Test with multiple samples and genome builds
  - [ ] Validate overlap analysis with known datasets
  - [ ] Compare outputs with original `typhon_old` results

### 3.3 Command Line Interface (CLI)
- [ ] Complete `cli.py` implementation
  - [ ] Add proper argument parsing
  - [ ] Integrate configuration file loading
  - [ ] Implement subcommands for different pipeline steps
  - [ ] Add help documentation and examples
- [ ] Test CLI functionality
- [ ] Create CLI usage documentation

### 3.4 Pipeline Orchestration
- [ ] Complete `pipeline.py` implementation
  - [ ] Design workflow coordination logic
  - [ ] Implement step-by-step execution
  - [ ] Add parallel processing capabilities
  - [ ] Integrate logging and progress tracking
- [ ] Add checkpoint and resume functionality
- [ ] Implement error recovery mechanisms

### 3.5 Logging and Error Handling
- [ ] Implement centralized logging system
  - [ ] Set up log levels and formatting
  - [ ] Add file and console logging
  - [ ] Include timestamp and context information
- [ ] Add comprehensive error handling
  - [ ] Create custom exception classes
  - [ ] Implement graceful failure recovery
  - [ ] Add user-friendly error messages

---

## Phase 4: Module Testing & Validation

### 4.1 Individual Module Testing
- [ ] Test LongGF module (`run_longgf.py`)
  - [ ] Verify minimap2 integration
  - [ ] Test BAM file processing
  - [ ] Validate R script execution
  - [ ] Check Excel output generation
- [ ] Test Genion module (`run_genion.py`)
  - [ ] Test with various input formats
  - [ ] Verify custom binary execution
  - [ ] Validate output file structure
- [ ] Test JaffaL setup (`setup_jaffal.py`)
  - [ ] Test installation process
  - [ ] Verify configuration modifications
  - [ ] Test reference file integration
- [ ] Test JaffaL execution (`run_jaffal.py`)
  - [ ] Test FASTQ to FASTA conversion
  - [ ] Verify bpipe execution
  - [ ] Test result aggregation and parsing
- [ ] Test utility functions
  - [ ] Reference preparation utilities
  - [ ] File compression/decompression
  - [ ] Cleanup and temporary file management

### 4.2 Integration Testing
- [ ] Test two-tool combinations
  - [ ] LongGF + Genion workflow
  - [ ] LongGF + JaffaL workflow
  - [ ] Genion + JaffaL workflow
- [ ] Test complete three-tool pipeline
- [ ] Validate data flow between modules
- [ ] Test with different input data types

### 4.3 Performance Testing
- [ ] Benchmark individual modules
- [ ] Test with large datasets
- [ ] Memory usage optimization
- [ ] Parallel processing efficiency
- [ ] Identify and resolve bottlenecks

### 4.4 Error Condition Testing
- [ ] Test with invalid input files
- [ ] Test with missing dependencies
- [ ] Test disk space limitations
- [ ] Test network connectivity issues
- [ ] Test partial file corruption scenarios

---

## Phase 5: Output Processing & Analysis

### 5.1 LongGF Output Processing
- [ ] Verify `postprocess.py` functionality
  - [ ] Test log file parsing
  - [ ] Validate R script integration
  - [ ] Check Excel file generation
- [ ] Optimize result formatting
- [ ] Add summary statistics generation

### 5.2 Genion Output Processing
- [ ] Implement Genion result parsing
- [ ] Create standardized output formats
- [ ] Add result filtering options
- [ ] Generate summary reports

### 5.3 JaffaL Output Processing
- [ ] Implement JaffaL result parsing
- [ ] Standardize output format with other tools
- [ ] Add comparative analysis features

### 5.4 Integrated Result Analysis
- [ ] Design cross-tool result comparison
- [ ] Implement consensus calling
- [ ] Create comprehensive summary reports
- [ ] Add visualization capabilities (optional)

---

## Phase 6: Documentation & User Experience

### 6.1 Code Documentation
- [ ] Add comprehensive docstrings to all functions
- [ ] Create inline code comments
- [ ] Generate API documentation
- [ ] Document configuration options

### 6.2 User Documentation
- [ ] Update main README.md
- [ ] Create installation guide
- [ ] Write step-by-step usage tutorial
- [ ] Document troubleshooting procedures
- [ ] Create example workflows

### 6.3 Developer Documentation
- [ ] Document code architecture
- [ ] Create contributing guidelines
- [ ] Document testing procedures
- [ ] Add development setup instructions

### 6.4 Reference Documentation
- [ ] Document required reference files
- [ ] Create reference preparation guides
- [ ] Document tool-specific requirements
- [ ] Add version compatibility information

---

## Phase 7: Pipeline Distribution & Installation

### 7.1 Repository Setup
- [ ] Finalize GitHub repository structure
- [ ] Create installation documentation
- [ ] Set up version tagging strategy
- [ ] Document system requirements

### 7.2 Container Support (Optional)
- [ ] Create Dockerfile
- [ ] Test container functionality
- [ ] Document container usage
- [ ] Publish to container registry

---

## Phase 8: Final Testing & Release Preparation

### 8.1 System Testing
- [ ] Test on multiple operating systems
- [ ] Test with different Python versions
- [ ] Test with various dependency versions
- [ ] Validate reproducibility across systems

### 8.2 User Acceptance Testing
- [ ] Create test datasets
- [ ] Conduct end-to-end testing
- [ ] Gather feedback from collaborators
- [ ] Address identified issues

### 8.3 Release Preparation
- [ ] Create release notes
- [ ] Tag stable version
- [ ] Archive development materials
- [ ] Plan maintenance strategy

---

## Progress Tracking

**Current Phase:** Phase 3.2 - JaffaL Integration (SETUP COMPLETE)  
**Overall Progress:** Phase 1 - Complete, Phase 2 - Complete, Phase 3.2.1 - Complete  
**Next Milestone:** Phase 3.2.2 - JaffaL Execution Module Implementation  

### Phase Completion Status
- [x] Phase 1: Environment & Project Structure Setup
- [x] Phase 2: Custom Genion Build & Integration  
- [ ] Phase 3: Core Pipeline Implementation
- [ ] Phase 4: Module Testing & Validation
- [ ] Phase 5: Output Processing & Analysis
- [ ] Phase 6: Documentation & User Experience
- [ ] Phase 7: Pipeline Distribution & Installation
- [ ] Phase 8: Final Testing & Release Preparation

---

## Notes and Decisions

*This section will be updated with important decisions, changes to scope, and lessons learned during development.*

- **Initial Assessment:** Pipeline has solid foundation with working modules but needs integration and proper orchestration
- **Key Dependencies:** Custom Genion build is critical path item
- **Testing Strategy:** Will focus on individual modules first, then integration testing
- **Environment Setup (Dec 2024):** Successfully resolved conda dependency conflicts by removing strict version pins. Final environment uses Python 3.9.23, R-base 4.4.3, and latest compatible package versions.
- **Additional Tools Added (07/15/2025):** Successfully added missing bioinformatics tools: bedops, clustalo, clustalw. Environment now matches original pipeline requirements except for custom Genion build.
- **Project Scope Clarification (07/15/2025):** Confirmed this is a pipeline project, not a distributable package. Removed packaging-related phases and focused on pipeline orchestration and direct execution.
- **Custom Genion Setup (07/15/2025):** Successfully implemented and tested custom Genion build with debug mode enabled for comprehensive chimeric RNA output.
- **Genion Reference Preparation (07/15/2025):** Successfully tested genion_reference.py utility with mouse Gencode references. GTF conversion, minimap2 self-alignment, and R script integration all working correctly. Reference files cached for efficiency.
- **Genion Integration Testing Complete (07/17/2025):** Successfully completed end-to-end LongGF + Genion integration testing. Updated genion_reference.py to match old pipeline GTF conversion exactly. Validated SAM-to-PAF conversion with paftools.js. Both test samples (R22-877, R22-882) produce identical results to original pipeline: 34 and 18 fusion candidates respectively. Debug mode preserved, all intermediate files managed correctly.
- **JaffaL Integration Analysis (07/17/2025):** Detailed analysis of original TYPHON bash scripts (`typhon_old/TYPHON_wrapper_script/`) reveals complex JaffaL integration requirements. Key findings:
  - Requires JAFFA v2.3 with custom modifications to `make_final_table.R` and `JAFFA_stages.groovy`
  - Uses UCSC reference files (genome FASTA, transcriptome, BED, TAB annotations)
  - Integrates with previous LongGF/Genion results via overlap analysis
  - Multi-step process: setup → FASTQ→FASTA conversion → bpipe execution → result aggregation
  - Critical R script: `Combine_chimera_results_and_create_overlap_file.R` performs three-way intersection analysis
- **JaffaL Setup Optimization (07/17/2025):** Achieved major breakthrough in JaffaL setup efficiency:
  - **90% time reduction:** Pre-installed dependencies via conda instead of individual compilation
  - **Environment isolation:** All tools contained within conda environment, no system pollution
  - **Smart tool configuration:** Auto-generated `tools.groovy` points to conda installations
  - **Streamlined process:** Single `python setup_jaffal.py` command vs. complex multi-stage setup
  - **Only 4 C++ tools** require compilation (JaffaL-specific), rest use conda packages

---

## Resources and References

- [Typhon GitHub Repository](https://github.com/erenada/TYPHON.git)
- [LongGF Documentation](link-to-longgf)
- [Genion Repository](https://github.com/vpc-ccg/genion)
- [JaffaL Documentation](https://github.com/Oshlack/JAFFA)
- [Original TYPHON Scripts Location](typhon_old/TYPHON_wrapper_script/)
- [JaffaL Reference Setup Guide](typhon_old/TYPHON_wrapper_script/README_for_downloading_JaffaL_reference_files.txt)
- [Conda Environment Guide](https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html) 
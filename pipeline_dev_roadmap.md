# Typhon Pipeline Development Roadmap

**Project:** Cleanup and improvement of chimeric RNA detection pipeline  
**Author:** Eren Ada, PhD  
**Created:** December 2024  
**Last Updated:** July 2025  

## Project Overview

Typhon is a modular pipeline for chimeric RNA detection that integrates LongGF, Genion (custom build), and JaffaL tools. This roadmap outlines the systematic cleanup, improvement, and testing phases to transform the current working prototype into a production-ready, well-documented pipeline.

---

## Phase 1: Environment & Project Structure Setup

### 1.1 Directory Structure Cleanup
- [x] Review and organize current file/folder structure
  - [x] Ensure proper Python package hierarchy (`__init__.py` files)
  - [ ] Verify module imports and dependencies
  - [ ] Clean up any redundant or outdated files
  - [ ] Organize documentation files logically

### 1.2 Python Module Structure (Adapted for Pipeline Project)
- [x] **COMPLETED:** Confirmed this is a pipeline project, not a distributable package
  - [x] Removed `setup.py` and packaging infrastructure (not needed for pipeline)
  - [x] Configured direct script execution instead of entry points
  - [x] Using `environment.yml` for dependency management instead of pip
- [x] Organized proper module hierarchy with `__init__.py` files
- [x] Set up imports for pipeline modules

### 1.3 Conda Environment Management
- [x] Review and update `environment.yml`
  - [x] Verify all required R packages are listed
  - [x] Ensure bioinformatics tools versions are compatible
  - [x] Add any missing Python dependencies
  - [x] Test environment creation from scratch
- [ ] Create environment setup documentation
- [ ] Test environment on clean system

---

## Phase 2: Custom Genion Build & Integration

### 2.1 Genion Setup Script
- [x] Test and fix `setup_genion.py`
  - [x] Verify git repository cloning works
  - [x] Test patch application process
  - [x] Ensure compilation succeeds on target systems
  - [x] Validate binary output and functionality
- [ ] Create fallback installation methods
- [ ] Document custom Genion requirements

### 2.2 Genion Reference Preparation
- [x] Test `genion_reference.py` utility functions
  - [x] Verify GTF conversion for Gencode/Ensembl
  - [x] Test self-alignment PAF generation
  - [x] Validate R script integration
- [x] Optimize reference file caching
- [x] Add error handling and validation

### 2.3 LongGF and Genion Integration Testing (REVISED)
- [x] **COMPLETED: Core Implementation**
  - [x] Created `command_utils.py` for shell command execution
  - [x] Implemented `run_genion.py` module with debug mode preservation
  - [x] Fixed debug file deletion bug (preserve `.fail` files, remove `.log` files)
  - [x] Updated `environment.yml` with `k8` dependency for `paftools.js`
  - [x] Created test script and verified basic functionality
- [x] **COMPLETED: LongGF Implementation**
  - [x] Implemented `run_longgf.py` module with complete workflow
  - [x] Created `postprocess.py` for log file processing
  - [x] Added `LongGF_process_results.R` for Excel/CSV output generation
  - [x] Created `test_run_longgf.py` for testing with real data
  - [x] Integrated minimap2 alignment, SAM/BAM processing, and LongGF execution
- [x] **COMPLETED: LongGF Production Testing and SAM Generation**
  - [x] Tested LongGF with real data from `typhon_old` samples (R22-877, R22-882)
  - [x] Generated SAM files for Genion integration (4.6GB + 4.8GB)
  - [x] Validated LongGF outputs: 341 fusion candidates detected
  - [x] Added dual output format (Excel + CSV) for tool compatibility
  - [x] Verified performance: ~17 minutes, 17GB peak RAM with 20 threads
  - [x] Confirmed compressed FASTQ handling and cleanup procedures
- [x] **COMPLETED: Complete Genion Integration Testing**
  - [x] Test Genion with SAM files generated by LongGF
  - [x] Verify SAM-to-PAF conversion with `paftools.js`
  - [x] Validate debug output format consistency with original results
  - [x] Test combined LongGF + Genion workflow end-to-end
- [ ] **TODO: Performance Testing**
  - [ ] Benchmark processing times for different file sizes
  - [ ] Test memory usage during large file processing
  - [ ] Verify parallel processing capabilities

---

## Phase 3: Core Pipeline Implementation

### 3.1 Main Pipeline Script and Configuration System
- [x] **COMPLETED: Main Pipeline Script (`typhon_main.py`)**
  - [x] Created main entry point with YAML configuration support
  - [x] Implemented command-line argument parsing with config file integration
  - [x] Added workflow orchestration (LongGF → Genion → JaffaL)
  - [x] Included progress tracking and professional logging output
  - [x] Added dry-run functionality and module selection options
- [x] **COMPLETED: YAML Configuration System**
  - [x] Designed YAML configuration schema for all pipeline parameters
  - [x] Defined input/output parameters with proper validation
  - [x] Set default values and validation rules
  - [x] Created example configuration files (mouse template)
- [x] **COMPLETED: Configuration Parser and Template Generation**
  - [x] Implemented configuration parser and validation
  - [x] Added configuration template generation (--generate-config)
  - [x] Added command-line override capabilities

### 3.2 Command Line Interface (CLI)
- [ ] Complete `cli.py` implementation
  - [ ] Add proper argument parsing
  - [ ] Integrate configuration file loading
  - [ ] Implement subcommands for different pipeline steps
  - [ ] Add help documentation and examples
- [ ] Test CLI functionality
- [ ] Create CLI usage documentation

### 3.3 Pipeline Orchestration
- [ ] Complete `pipeline.py` implementation
  - [ ] Design workflow coordination logic
  - [ ] Implement step-by-step execution
  - [ ] Add parallel processing capabilities
  - [ ] Integrate logging and progress tracking
- [ ] Add checkpoint and resume functionality
- [ ] Implement error recovery mechanisms

### 3.4 JaffaL Integration
- [ ] Complete `run_jaffal.py` implementation
  - [ ] Design JaffaL execution workflow
  - [ ] Handle UCSC reference file requirements
  - [ ] Integrate with setup_jaffal.py
  - [ ] Add result parsing and formatting
- [ ] Test JaffaL module independently
- [ ] Integrate with main pipeline

### 3.5 Logging and Error Handling
- [ ] Implement centralized logging system
  - [ ] Set up log levels and formatting
  - [ ] Add file and console logging
  - [ ] Include timestamp and context information
- [ ] Add comprehensive error handling
  - [ ] Create custom exception classes
  - [ ] Implement graceful failure recovery
  - [ ] Add user-friendly error messages

---

## Phase 4: Module Testing & Validation

### 4.1 Individual Module Testing
- [ ] Test LongGF module (`run_longgf.py`)
  - [ ] Verify minimap2 integration
  - [ ] Test BAM file processing
  - [ ] Validate R script execution
  - [ ] Check Excel output generation
- [ ] Test Genion module (`run_genion.py`)
  - [ ] Test with various input formats
  - [ ] Verify custom binary execution
  - [ ] Validate output file structure
- [ ] Test JaffaL setup (`setup_jaffal.py`)
  - [ ] Test installation process
  - [ ] Verify configuration modifications
  - [ ] Test reference file integration
- [ ] Test utility functions
  - [ ] Reference preparation utilities
  - [ ] File compression/decompression
  - [ ] Cleanup and temporary file management

### 4.2 Integration Testing
- [ ] Test two-tool combinations
  - [ ] LongGF + Genion workflow
  - [ ] LongGF + JaffaL workflow
  - [ ] Genion + JaffaL workflow
- [ ] Test complete three-tool pipeline
- [ ] Validate data flow between modules
- [ ] Test with different input data types

### 4.3 Performance Testing
- [ ] Benchmark individual modules
- [ ] Test with large datasets
- [ ] Memory usage optimization
- [ ] Parallel processing efficiency
- [ ] Identify and resolve bottlenecks

### 4.4 Error Condition Testing
- [ ] Test with invalid input files
- [ ] Test with missing dependencies
- [ ] Test disk space limitations
- [ ] Test network connectivity issues
- [ ] Test partial file corruption scenarios

---

## Phase 5: Output Processing & Analysis

### 5.1 LongGF Output Processing
- [ ] Verify `postprocess.py` functionality
  - [ ] Test log file parsing
  - [ ] Validate R script integration
  - [ ] Check Excel file generation
- [ ] Optimize result formatting
- [ ] Add summary statistics generation

### 5.2 Genion Output Processing
- [ ] Implement Genion result parsing
- [ ] Create standardized output formats
- [ ] Add result filtering options
- [ ] Generate summary reports

### 5.3 JaffaL Output Processing
- [ ] Implement JaffaL result parsing
- [ ] Standardize output format with other tools
- [ ] Add comparative analysis features

### 5.4 Integrated Result Analysis
- [ ] Design cross-tool result comparison
- [ ] Implement consensus calling
- [ ] Create comprehensive summary reports
- [ ] Add visualization capabilities (optional)

---

## Phase 6: Documentation & User Experience

### 6.1 Code Documentation
- [ ] Add comprehensive docstrings to all functions
- [ ] Create inline code comments
- [ ] Generate API documentation
- [ ] Document configuration options

### 6.2 User Documentation
- [ ] Update main README.md
- [ ] Create installation guide
- [ ] Write step-by-step usage tutorial
- [ ] Document troubleshooting procedures
- [ ] Create example workflows

### 6.3 Developer Documentation
- [ ] Document code architecture
- [ ] Create contributing guidelines
- [ ] Document testing procedures
- [ ] Add development setup instructions

### 6.4 Reference Documentation
- [ ] Document required reference files
- [ ] Create reference preparation guides
- [ ] Document tool-specific requirements
- [ ] Add version compatibility information

---

## Phase 7: Pipeline Distribution & Installation

### 7.1 Repository Setup
- [ ] Finalize GitHub repository structure
- [ ] Create installation documentation
- [ ] Set up version tagging strategy
- [ ] Document system requirements

### 7.2 Container Support (Optional)
- [ ] Create Dockerfile
- [ ] Test container functionality
- [ ] Document container usage
- [ ] Publish to container registry

---

## Phase 8: Final Testing & Release Preparation

### 8.1 System Testing
- [ ] Test on multiple operating systems
- [ ] Test with different Python versions
- [ ] Test with various dependency versions
- [ ] Validate reproducibility across systems

### 8.2 User Acceptance Testing
- [ ] Create test datasets
- [ ] Conduct end-to-end testing
- [ ] Gather feedback from collaborators
- [ ] Address identified issues

### 8.3 Release Preparation
- [ ] Create release notes
- [ ] Tag stable version
- [ ] Archive development materials
- [ ] Plan maintenance strategy

---

## Progress Tracking

**Current Phase:** Phase 2 - Custom Genion Build & Integration (COMPLETE)  
**Overall Progress:** Phase 1 - Complete, Phase 2 - Complete  
**Next Milestone:** Begin Phase 3 - Core Pipeline Implementation  

### Phase Completion Status
- [x] Phase 1: Environment & Project Structure Setup
- [x] Phase 2: Custom Genion Build & Integration  
- [ ] Phase 3: Core Pipeline Implementation
- [ ] Phase 4: Module Testing & Validation
- [ ] Phase 5: Output Processing & Analysis
- [ ] Phase 6: Documentation & User Experience
- [ ] Phase 7: Pipeline Distribution & Installation
- [ ] Phase 8: Final Testing & Release Preparation

---

## Notes and Decisions

*This section will be updated with important decisions, changes to scope, and lessons learned during development.*

- **Initial Assessment:** Pipeline has solid foundation with working modules but needs integration and proper orchestration
- **Key Dependencies:** Custom Genion build is critical path item
- **Testing Strategy:** Will focus on individual modules first, then integration testing
- **Environment Setup (Dec 2024):** Successfully resolved conda dependency conflicts by removing strict version pins. Final environment uses Python 3.9.23, R-base 4.4.3, and latest compatible package versions.
- **Additional Tools Added (07/15/2025):** Successfully added missing bioinformatics tools: bedops, clustalo, clustalw. Environment now matches original pipeline requirements except for custom Genion build.
- **Project Scope Clarification (07/15/2025):** Confirmed this is a pipeline project, not a distributable package. Removed packaging-related phases and focused on pipeline orchestration and direct execution.
- **Custom Genion Setup (07/15/2025):** Successfully implemented and tested custom Genion build with debug mode enabled for comprehensive chimeric RNA output.
- **Genion Reference Preparation (07/15/2025):** Successfully tested genion_reference.py utility with mouse Gencode references. GTF conversion, minimap2 self-alignment, and R script integration all working correctly. Reference files cached for efficiency.
- **Genion Integration Testing Complete (07/17/2025):** Successfully completed end-to-end LongGF + Genion integration testing. Updated genion_reference.py to match old pipeline GTF conversion exactly. Validated SAM-to-PAF conversion with paftools.js. Both test samples (R22-877, R22-882) produce identical results to original pipeline: 34 and 18 fusion candidates respectively. Debug mode preserved, all intermediate files managed correctly.

---

## Resources and References

- [Typhon GitHub Repository](https://github.com/erenada/TYPHON.git)
- [LongGF Documentation](link-to-longgf)
- [Genion Repository](https://github.com/vpc-ccg/genion)
- [JaffaL Documentation](https://github.com/Oshlack/JAFFA)
- [Conda Environment Guide](https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html) 